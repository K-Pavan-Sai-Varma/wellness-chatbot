<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Wellness Chatbot</title>

<!-- ✅ Online Bootstrap and Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f0f4f5; }
  .sidebar { width:250px; background:#e6f2e6; padding:20px; height:100vh; float:left;
    display:flex; flex-direction:column; justify-content:space-between; border-right:3px solid #4CAF50; }
  .sidebar h4 { margin-top:0; font-weight:bold; text-align:center; font-size:16px; margin-bottom:2cm; }
  .new-chat-btn { background:#4CAF50; color:white; padding:8px; border-radius:8px; text-align:center; cursor:pointer; margin-bottom:1cm; display:flex; align-items:center; gap:8px; justify-content:center; }
  .chat-history-header { font-weight:bold; display:flex; align-items:center; gap:8px; color:#333; }
  .chat-tabs { flex-grow:1; overflow-y:auto; margin-top:10px; display:flex; flex-direction:column; gap:6px; }
  .chat-tabs .tab { padding:10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px; border:1px solid transparent; }
  .chat-tabs .tab.active { background:#4CAF50; color:white; border-color:#388E3C; }
  .bottom-buttons { display:flex; flex-direction:column; gap:10px; }
  .bottom-buttons a { color:white; padding:10px; border-radius:8px; text-decoration:none; display:block; text-align:center; font-weight:600; }
  .bottom-buttons a.profile { background:#007bff; }
  .bottom-buttons a.logout { background:#dc3545; }

  .chat-container { margin-left:250px; padding:20px; height:100vh; display:flex; flex-direction:column; }
  .heading { font-size:24px; font-weight:bold; color:white; background:#4CAF50; padding:12px; text-align:center; border-radius:8px; margin-bottom:12px; }

  .chat-box { flex-grow:1; background:#ffffff; padding:15px; border-radius:10px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; border:3px solid #4CAF50; }
  .message { padding:10px 15px; border-radius:15px; max-width:70%; word-wrap:break-word; box-shadow:0 2px 6px rgba(0,0,0,0.06); position:relative; }
  .user-message { background:#d1e7ff; align-self:flex-end; text-align:right; }
  .bot-message { background:#f1f8e9; align-self:flex-start; text-align:left; }

  .feedback-icons { display:flex; gap:12px; margin-top:5px; color:#6c757d; font-size:18px; }
  .feedback-icons i:hover { color:#4CAF50; cursor:pointer; }

  .input-container { display:flex; gap:10px; margin-top:10px; }
  .input-container input { flex-grow:1; padding:10px; border-radius:10px; border:2px solid #4CAF50; }
  .input-container button { padding:10px 15px; border-radius:10px; border:none; background:#4CAF50; color:white; display:flex; align-items:center; gap:8px; }
  .input-container button:hover { background:#43a047; }

  .toast-container { position:fixed; bottom:20px; right:20px; z-index:1055; }
</style>
</head>
<body>

<div class="sidebar">
  <div>
    <h4><i class="bi bi-person-circle"></i> {{ user['name'] or 'Unknown' }}</h4>
    <div class="new-chat-btn" onclick="newChat()"><i class="bi bi-plus-circle"></i> New Chat</div>
    <div class="chat-history-header"><i class="bi bi-clock-history"></i> Chat History</div>
    <div class="chat-tabs" id="chat-history"></div>
  </div>
  <div class="bottom-buttons">
    <a href="{{ url_for('profile') }}" class="profile"><i class="bi bi-gear"></i> Profile</a>
    <a href="{{ url_for('home_index') }}" class="logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
  </div>
</div>

<div class="chat-container">
  <div class="heading">Global Wellness Chatbot</div>
  <div class="chat-box" id="chat-box"></div>
  <div class="input-container">
    <input type="text" id="user-input" placeholder="Type a message..." />
    <button id="send-btn" onclick="sendMessage()"><i class="bi bi-send-fill"></i> Send</button>
  </div>
</div>

<div class="toast-container">
  <div id="thankToast" class="toast align-items-center text-bg-success border-0" role="alert">
    <div class="d-flex"><div class="toast-body">Thank you for your feedback!</div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let chatHistory = [];
let currentChat = [];
let currentTabIndex = -1;
const MAX_TABS = 5;

const chatBox = document.getElementById('chat-box');
const historyDiv = document.getElementById('chat-history');

// ✅ append messages
function appendMessage(role, msg) {
  const div = document.createElement('div');
  div.className = 'message ' + (role === 'You' ? 'user-message' : 'bot-message');
  div.innerText = msg;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;

  if (role === 'Bot') addFeedbackIcons(div);
}

// ✅ feedback section (merged thumbs + comment)
function addFeedbackIcons(div) {
  const icons = document.createElement('div');
  icons.className = 'feedback-icons';
  icons.innerHTML = `
    <i class="bi bi-hand-thumbs-up" title="Good"></i>
    <i class="bi bi-hand-thumbs-down" title="Bad"></i>
    <i class="bi bi-chat-dots" title="Add comment"></i>
  `;
  div.appendChild(icons);

  const [thumbUp, thumbDown, commentIcon] = icons.querySelectorAll('i');
  let selectedFeedback = null; // remember what user clicked

  thumbUp.addEventListener('click', () => {
    selectedFeedback = 'positive';
    thumbUp.style.color = 'green';
    thumbDown.style.color = '#6c757d';
    sendFeedback(selectedFeedback, div.dataset.pendingComment || null, div);
    div.dataset.pendingComment = '';
  });

  thumbDown.addEventListener('click', () => {
    selectedFeedback = 'negative';
    thumbDown.style.color = 'red';
    thumbUp.style.color = '#6c757d';
    sendFeedback(selectedFeedback, div.dataset.pendingComment || null, div);
    div.dataset.pendingComment = '';
  });

  commentIcon.addEventListener('click', () => {
    if (div.querySelector('.comment-box')) return;
    const box = document.createElement('div');
    box.className = 'comment-box mt-2';
    box.innerHTML = `
      <div class="input-group input-group-sm">
        <input type="text" class="form-control" placeholder="Write a comment..." />
        <button class="btn btn-success" type="button"><i class="bi bi-send"></i></button>
      </div>
    `;
    div.appendChild(box);

    const input = box.querySelector('input');
    const button = box.querySelector('button');

    button.addEventListener('click', () => {
      const comment = input.value.trim();
      if (comment) {
        div.dataset.pendingComment = comment;
        sendFeedback(selectedFeedback, comment, div);
        div.removeChild(box);
      }
    });
  });
}

// ✅ unified feedback send — shows “Thank you!” below message (only one copy)
function sendFeedback(type = null, comment = null, div = null) {
  if (!type && !comment) return;

  fetch('/submit_feedback', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ feedback: type, comment: comment })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success && div) {
      // ✅ Remove existing thank-you message (if already shown)
      const existingThank = div.querySelector('.thank-msg');
      if (existingThank) existingThank.remove();

      // ✅ Add new thank-you message
      const thankMsg = document.createElement('div');
      thankMsg.className = 'small text-success mt-1 thank-msg';
      thankMsg.innerText = '✓ Thank you for your feedback!';
      div.appendChild(thankMsg);
    }
  })
  .catch(err => console.error('Feedback error:', err));
}

// ✅ sidebar updates
function updateHistorySidebar() {
  historyDiv.innerHTML = '';
  chatHistory.forEach((chat, index) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (index === currentTabIndex ? ' active' : '');
    const icon = document.createElement('i');
    icon.className = 'bi bi-clock-history';
    const label = document.createElement('div');
    label.style.flex='1';
    label.style.whiteSpace='nowrap';
    label.style.overflow='hidden';
    label.style.textOverflow='ellipsis';
    label.textContent = chat[0]?.text || 'New Chat';
    tab.appendChild(icon);
    tab.appendChild(label);
    tab.onclick = () => loadChat(index);
    historyDiv.appendChild(tab);
  });
}

function loadChat(index) {
  currentTabIndex = index;
  currentChat = [...chatHistory[index]];
  chatBox.innerHTML = '';
  currentChat.forEach(m => appendMessage(m.role, m.text));
  updateHistorySidebar();
}

// ✅ message sending
function sendMessage() {
  const userInputEl = document.getElementById('user-input');
  let message = userInputEl.value.trim();
  if (!message) return;
  userInputEl.value = '';

  appendMessage('You', message);
  currentChat.push({ role: 'You', text: message });

  fetch('/send_message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ user_message: message })
  })
  .then(res => res.json())
  .then(data => {
    appendMessage('Bot', data.bot_reply);
    currentChat.push({ role: 'Bot', text: data.bot_reply });

    if (currentTabIndex === -1) {
      if (chatHistory.length === MAX_TABS) chatHistory.shift();
      chatHistory.push([...currentChat]);
      currentTabIndex = chatHistory.length - 1;
    } else {
      chatHistory[currentTabIndex] = [...currentChat];
    }
    updateHistorySidebar();
  })
  .catch(err => {
    appendMessage('Bot', '❗ Error contacting server.');
    console.error(err);
  });
}

function newChat() {
  currentChat = [];
  currentTabIndex = -1;
  chatBox.innerHTML = '';
  updateHistorySidebar();
}

document.getElementById('user-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendMessage();
});

newChat();
</script>

</body>
</html>
