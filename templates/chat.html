<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Global Wellness Chatbot</title>

<!-- ‚úÖ Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f0f4f5; }
  .sidebar { width:250px; background:#e6f2e6; padding:20px; height:100vh; float:left;
    display:flex; flex-direction:column; justify-content:space-between; border-right:3px solid #4CAF50; }
  .sidebar h4 { margin-top:0; font-weight:bold; text-align:center; font-size:16px; margin-bottom:2cm; }
  .new-chat-btn { background:#4CAF50; color:white; padding:8px; border-radius:8px; text-align:center; cursor:pointer; margin-bottom:1cm; display:flex; align-items:center; gap:8px; justify-content:center; }
  .chat-history-header { font-weight:bold; display:flex; align-items:center; gap:8px; color:#333; }
  .chat-tabs { flex-grow:1; overflow-y:auto; margin-top:10px; display:flex; flex-direction:column; gap:6px; }
  .chat-tabs .tab { padding:10px; border-radius:8px; cursor:pointer; display:flex; align-items:center; gap:8px; border:1px solid transparent; }
  .chat-tabs .tab.active { background:#4CAF50; color:white; border-color:#388E3C; }
  .bottom-buttons { display:flex; flex-direction:column; gap:10px; }
  .bottom-buttons a { color:white; padding:10px; border-radius:8px; text-decoration:none; display:block; text-align:center; font-weight:600; }
  .bottom-buttons a.profile { background:#9400D3; }
  .bottom-buttons a.logout { background:#FF8C00; }
  .bottom-buttons a.delete-account { background:#ff0000; }
  .bottom-buttons a.delete-account:hover { background:#ff0000; }

  .chat-container { margin-left:250px; padding:20px; height:100vh; display:flex; flex-direction:column; }
  .heading { font-size:24px; font-weight:bold; color:white; background:#4CAF50; padding:12px; text-align:center; border-radius:8px; margin-bottom:12px; }

  .chat-box { flex-grow:1; background:#ffffff; padding:15px; border-radius:10px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; border:3px solid #4CAF50; }
  .message { padding:10px 15px; border-radius:15px; max-width:70%; word-wrap:break-word; box-shadow:0 2px 6px rgba(0,0,0,0.06); position:relative; }
  .user-message { background:#d1e7ff; align-self:flex-end; text-align:right; }
  .bot-message { background:#f1f8e9; align-self:flex-start; text-align:left; }

  .feedback-icons { display:flex; align-items:center; justify-content:flex-end; gap:15px; margin-top:6px; color:#6c757d; font-size:18px; }
  .feedback-icons i:hover { color:#4CAF50; cursor:pointer; }

  .input-container { display:flex; gap:10px; margin-top:10px; align-items:center; }
  .input-container input { flex-grow:1; padding:10px; border-radius:10px; border:2px solid #4CAF50; }
  .input-container button { padding:10px 15px; border-radius:10px; border:none; background:#4CAF50; color:white; display:flex; align-items:center; gap:8px; }
  .input-container button:hover { background:#43a047; }

  /* üé§ Mic Button Style */
  #mic-btn {
    background:#f44336;
    color:white;
    border:none;
    border-radius:10px;
    padding:10px 15px;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: all 0.3s ease;
  }
  #mic-btn.recording {
    background:#d32f2f;
    animation:pulse 1s infinite;
  }
  @keyframes pulse {
    0% { box-shadow:0 0 0 0 rgba(244,67,54,0.5); }
    70% { box-shadow:0 0 0 10px rgba(244,67,54,0); }
    100% { box-shadow:0 0 0 0 rgba(244,67,54,0); }
  }

  .toast-container { position:fixed; bottom:20px; right:20px; z-index:1055; }
</style>
</head>
<body>

<div class="sidebar">
  <div>
    <h4><i class="bi bi-person-circle"></i> {{ user['name'] or 'Unknown' }}</h4>
    <div class="new-chat-btn" onclick="newChat()"><i class="bi bi-plus-circle"></i> New Chat</div>
    <div class="chat-history-header"><i class="bi bi-clock-history"></i> Chat History</div>
    <div class="chat-tabs" id="chat-history"></div>
  </div>
  <div class="bottom-buttons">
    <a href="{{ url_for('profile') }}" class="profile"><i class="bi bi-gear"></i> Profile</a>
    <a href="{{ url_for('home_index') }}" class="logout"><i class="bi bi-box-arrow-right"></i> Logout</a>
    <a href="#" class="delete-account" onclick="confirmDeleteAccount()"><i class="bi bi-trash"></i> Delete Account</a>
  </div>
</div>

<div class="chat-container">
  <div class="heading">Global Wellness Chatbot</div>
  <div class="chat-box" id="chat-box"></div>
  <div class="input-container">
    <input type="text" id="user-input" placeholder="Type a message..." />
    <button id="mic-btn" title="Voice Input"><i class="bi bi-mic-fill"></i></button>
    <button id="send-btn"><i class="bi bi-send-fill"></i> Send</button>
  </div>
</div>

<!-- ‚úÖ Toast for success -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="successToast" class="toast text-bg-success border-0">
    <div class="d-flex">
      <div class="toast-body">‚úÖ Account deleted successfully!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let chatHistory = [];
let currentChat = [];
let currentTabIndex = -1;
const MAX_TABS = 5;
const chatBox = document.getElementById('chat-box');
const historyDiv = document.getElementById('chat-history');
const micBtn = document.getElementById('mic-btn');

// ‚úÖ Speech Recognition
let recognizing = false;
let recognition;
if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-IN';
  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onstart = () => {
    recognizing = true;
    micBtn.classList.add('recording');
  };
  recognition.onend = () => {
    recognizing = false;
    micBtn.classList.remove('recording');
  };
  recognition.onresult = e => {
    const transcript = e.results[0][0].transcript.trim();
    document.getElementById('user-input').value = transcript;
    sendMessage();
  };
}

micBtn.addEventListener('click', () => {
  if (!recognition) return alert('Speech recognition not supported.');
  recognizing ? recognition.stop() : recognition.start();
});

// ‚úÖ Text-to-speech
let currentUtterance = null;
function toggleSpeak(text, icon) {
  const synth = window.speechSynthesis;
  if (!synth) return;

  if (synth.speaking && currentUtterance) {
    synth.cancel();
    icon.style.color = "#6c757d";
    currentUtterance = null;
    return;
  }

  const cleanText = text.replace(/([\u2700-\u27BF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF])/g, '').trim();
  const utter = new SpeechSynthesisUtterance(cleanText);
  utter.lang = /[‡§Ö-‡§π]/.test(cleanText) ? 'hi-IN' : 'en-IN';
  utter.rate = 1;
  utter.pitch = 1;
  utter.volume = 1;

  synth.speak(utter);
  currentUtterance = utter;
  icon.style.color = "#4CAF50";

  utter.onend = () => { icon.style.color = "#6c757d"; currentUtterance = null; };
}

// ‚úÖ Append Messages
function appendMessage(role, msg) {
  const div = document.createElement('div');
  div.className = 'message ' + (role === 'You' ? 'user-message' : 'bot-message');
  div.innerText = msg;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;

  if (role === 'Bot') addFeedbackSection(div, msg);
}

// ‚úÖ Feedback + Speaker Section
function addFeedbackSection(div, msg) {
  const section = document.createElement('div');
  section.className = 'feedback-icons';
  section.innerHTML = `
    <i class="bi bi-hand-thumbs-up" title="Good"></i>
    <i class="bi bi-hand-thumbs-down" title="Bad"></i>
    <i class="bi bi-chat-dots" title="Add comment"></i>
    <i class="bi bi-volume-up-fill" title="Read aloud"></i>
  `;
  div.appendChild(section);

  const [thumbUp, thumbDown, commentIcon, speaker] = section.querySelectorAll('i');
  let selectedFeedback = null;

  thumbUp.addEventListener('click', () => {
    selectedFeedback = 'positive';
    thumbUp.style.color = 'green';
    thumbDown.style.color = '#6c757d';
    sendFeedback('positive', div.dataset.pendingComment || null, div);
  });

  thumbDown.addEventListener('click', () => {
    selectedFeedback = 'negative';
    thumbDown.style.color = 'red';
    thumbUp.style.color = '#6c757d';
    sendFeedback('negative', div.dataset.pendingComment || null, div);
  });

  commentIcon.addEventListener('click', () => {
    if (div.querySelector('.comment-box')) return;
    const box = document.createElement('div');
    box.className = 'comment-box mt-2';
    box.innerHTML = `
      <div class="input-group input-group-sm">
        <input type="text" class="form-control" placeholder="Write a comment..." />
        <button class="btn btn-success" type="button"><i class="bi bi-send"></i></button>
      </div>`;
    div.appendChild(box);

    const input = box.querySelector('input');
    const button = box.querySelector('button');
    button.addEventListener('click', () => {
      const comment = input.value.trim();
      if (comment) {
        div.dataset.pendingComment = comment;
        sendFeedback(selectedFeedback, comment, div);
        box.remove();
      }
    });
  });

  speaker.addEventListener('click', () => toggleSpeak(msg, speaker));
}

// ‚úÖ Feedback submission
function sendFeedback(type = null, comment = null, div = null) {
  if (!type && !comment) return;
  fetch('/submit_feedback', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ feedback: type, comment: comment })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success && div) {
      const thankMsg = document.createElement('div');
      thankMsg.className = 'small text-success mt-1';
      thankMsg.innerText = '‚úì Thank you for your feedback!';
      div.appendChild(thankMsg);
    }
  })
  .catch(err => console.error('Feedback error:', err));
}

// ‚úÖ Chat System
function updateHistorySidebar() {
  historyDiv.innerHTML = '';
  chatHistory.forEach((chat, index) => {
    const tab = document.createElement('div');
    tab.className = 'tab' + (index === currentTabIndex ? ' active' : '');
    tab.innerHTML = `<i class="bi bi-clock-history"></i> ${chat[0]?.text || 'New Chat'}`;
    tab.onclick = () => loadChat(index);
    historyDiv.appendChild(tab);
  });
}

function loadChat(index) {
  currentTabIndex = index;
  currentChat = [...chatHistory[index]];
  chatBox.innerHTML = '';
  currentChat.forEach(m => appendMessage(m.role, m.text));
  updateHistorySidebar();
}

function sendMessage() {
  const input = document.getElementById('user-input');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  appendMessage('You', message);
  currentChat.push({ role: 'You', text: message });

  fetch('/send_message', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ user_message: message })
  })
  .then(res => res.json())
  .then(data => {
    appendMessage('Bot', data.bot_reply);
    currentChat.push({ role: 'Bot', text: data.bot_reply });
    if (currentTabIndex === -1) {
      if (chatHistory.length === MAX_TABS) chatHistory.shift();
      chatHistory.push([...currentChat]);
      currentTabIndex = chatHistory.length - 1;
    } else {
      chatHistory[currentTabIndex] = [...currentChat];
    }
    updateHistorySidebar();
  })
  .catch(err => {
    appendMessage('Bot', '‚ùó Error contacting server.');
    console.error(err);
  });
}

function newChat() {
  currentChat = [];
  currentTabIndex = -1;
  chatBox.innerHTML = '';
  updateHistorySidebar();
}

// ‚úÖ Delete Account confirmation modal
function confirmDeleteAccount() {
  const modalHTML = `
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-2 border-danger">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <p>‚ö† Are you sure you want to permanently delete your account?</p>
            <p>This action <b>cannot be undone</b>.</p>
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  modal.show();

  document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
    fetch("/delete_account", { method: "POST", headers: { "Content-Type": "application/json" } })
    .then(res => res.json())
    .then(data => {
      modal.hide();
      if (data.success) {
        const toast = new bootstrap.Toast(document.getElementById('successToast'));
        toast.show();
        setTimeout(() => { window.location.href = "/login"; }, 2500);
      } else {
        alert("‚ùå " + data.message);
      }
    })
    .catch(err => { alert("Server error"); console.error(err); });
  });
}

// ‚úÖ Event listeners
document.getElementById('send-btn').addEventListener('click', sendMessage);
document.getElementById('user-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

newChat();
</script>
</body>
</html>
